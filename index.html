<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Founder OS</title>

    <!-- PWA -->
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#0f172a" />

    <style>
      body {
        margin: 0;
        font-family: system-ui, sans-serif;
        background: #0f172a;
        color: #e5e7eb;
      }

      nav {
        display: flex;
        justify-content: space-around;
        padding: 12px;
        background: #020617;
        position: sticky;
        top: 0;
      }

      nav a {
        color: #e5e7eb;
        text-decoration: none;
        font-size: 14px;
      }

      main {
        padding: 20px;
      }

      .card,
      .intro-card {
        padding: 16px;
        border-radius: 12px;
        margin-bottom: 16px;
      }
      .intro-card {
        background: #02101f;
      }
      #app {
        width: 100%;
      }
      .page-wrapper {
        display: flex;
        justify-content: center;
        width: 100%;
      }
      main {
        width: 80%;
        padding: 16px;
        max-width: 720px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
      }

      h1 {
        margin-top: 0;
        font-size: 20px;
        font-weight: 600;
      }

      /* ───────── Inputs (Add Task Area) ───────── */

      input,
      select,
      textarea {
        width: 100%;
        padding: 10px 0px;
        margin-top: 6px;
        border-radius: 8px;
        border: none;
        font-size: 14px;
        background: #020617;
        color: var(--text-primary);
      }

      textarea {
        resize: vertical;
      }

      button {
        margin-top: 8px;
        background: #2563eb;
        color: white;
        border: none;
        padding: 10px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
      }
      #authPanel {
        display: flex;
        flex-direction: column;
        width: 100%;
      }
      @media (max-width: 600px) {
        main {
          padding: 12px;
          width: 85%;
          margin: 0;
        }

        h1 {
          font-size: 18px;
        }

        /* Inputs feel lighter */
        input,
        select,
        textarea {
          padding: 10px 0px;
          font-size: 13px;
        }

        textarea {
          min-height: 48px;
        }

        /* Nav readability */
        nav a {
          font-size: 13px;
        }
      }
    </style>
  </head>
  <script>
    function handleAuth() {
      alert("Auth not wired yet");
    }
  </script>

  <body>
    <div class="page-wrapper">
      <div id="app">
        <main>
          <!-- rest of page content -->

          <h1>Founder OS</h1>
          <div id="authPanel" style="display: none; margin-bottom: 16px">
            <div class="card">
              <small class="small">Account</small>
              <input id="authEmail" type="email" placeholder="Email" />
              <input id="authPassword" type="password" placeholder="Password" />

              <div style="display: flex; gap: 12px; margin-top: 8px">
                <span onclick="linkAccount()" style="cursor: pointer"
                  >Create Account</span
                >
                <span onclick="signIn()" style="cursor: pointer">Sign In</span>
              </div>
            </div>
          </div>

          <div class="intro-card">
            <h3>Welcome</h3>
            <p>This is your founder dashboard. More coming next.</p>
          </div>

          <!-- CREATE PROJECT -->
          <div class="card" id="createProjectSection">
            <h3>New Project</h3>
            <input id="projectName" placeholder="Project name" />
            <textarea
              id="projectNotes"
              placeholder="Initial notes (optional)"
              style="min-height: 60px"
            ></textarea>
            <button id="createProjectBtn">Create Project</button>
          </div>

          <!-- PROJECTS LIST -->
          <div id="projectsList"></div>
        </main>
      </div>
    </div>
    <script type="module">
      import { injectNav, updateProjectSwitcher } from "./js/nav.js";
      injectNav("dashboard");

      import { initAuthGate } from "./js/auth-gate.js";
      import { logout } from "./js/auth.js";
      window.logout = logout;

      import "./js/auth-ui.js"; // bring in linkAccount/signIn globally

      import {
        initProjectContext,
        getActiveProjectId,
      } from "./js/project-context.js";
      import { loadProjects, createProject } from "./js/projects.js";

      initAuthGate((userId) => {
        // Load and display projects
        loadProjects(userId, (projects) => {
          // Set active project if not set
          if (!getActiveProjectId() && projects.length > 0) {
            initProjectContext(projects[0].id);
          } else {
            initProjectContext(getActiveProjectId());
          }

          // Update project switcher
          updateProjectSwitcher(projects);

          // Display projects list
          displayProjects(projects);
        });

        // Create project handler
        document
          .getElementById("createProjectBtn")
          .addEventListener("click", async () => {
            const name = document.getElementById("projectName").value.trim();
            const notes = document.getElementById("projectNotes").value.trim();

            if (!name) {
              alert("Project name required");
              return;
            }

            try {
              await createProject(userId, name, notes);
              document.getElementById("projectName").value = "";
              document.getElementById("projectNotes").value = "";
              // Projects will refresh automatically via listener
            } catch (err) {
              alert("Error creating project: " + err.message);
            }
          });
      });

      function displayProjects(projects) {
        const list = document.getElementById("projectsList");
        list.innerHTML = "";

        if (projects.length === 0) {
          list.innerHTML = "<p>No projects yet. Create one to get started.</p>";
          return;
        }

        projects.forEach((project) => {
          const div = document.createElement("div");
          div.className = "card";
          div.innerHTML = `
            <h3>${project.name}</h3>
            <p>Status: ${project.status}</p>
            <small>Created ${new Date(
              project.createdAt
            ).toLocaleDateString()}</small>
          `;
          list.appendChild(div);
        });
      }

      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker.register("./sw.js").then(() => {
            console.log("Service Worker registered successfully");
          });
        });
      }
    </script>
    <!-- Service Worker -->
    <script>
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("sw.js");
      }
    </script>
  </body>
</html>
