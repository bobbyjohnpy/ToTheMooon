<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tasks ‚Äì Founder OS</title>

    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#0f172a" />

    <style>
      body {
        margin: 0;
        font-family: system-ui, sans-serif;
        background: #0f172a;
        color: #e5e7eb;
      }

      nav {
        display: flex;
        justify-content: space-around;
        padding: 12px;
        background: #020617;
        position: sticky;
        top: 0;
      }

      nav a {
        color: #e5e7eb;
        text-decoration: none;
        font-size: 14px;
      }

      main {
        padding: 16px;
      }

      h1 {
        margin-top: 0;
      }

      .card {
        background: #020617;
        border-radius: 12px;
        padding: 14px;
        margin-bottom: 14px;
      }

      input,
      select,
      textarea,
      button {
        width: 100%;
        padding: 10px;
        margin-top: 6px;
        border-radius: 8px;
        border: none;
        font-size: 14px;
      }

      button {
        background: #2563eb;
        color: white;
        cursor: pointer;
      }

      .task {
        border-left: 6px solid gray;
      }

      .urgent-critical {
        border-color: #dc2626;
      }
      .urgent-high {
        border-color: #f97316;
      }
      .urgent-medium {
        border-color: #eab308;
      }
      .urgent-low {
        border-color: #22c55e;
      }

      .task-title {
        font-weight: bold;
      }

      .note {
        background: #020617;
        padding: 8px;
        border-radius: 8px;
        margin-top: 6px;
        font-size: 13px;
      }

      .small {
        font-size: 12px;
        opacity: 0.7;
      }
      .task.high {
        border-left: 6px solid #dc2626;
      }
      .task.medium {
        border-left: 6px solid #f59e0b;
      }
      .task.low {
        border-left: 6px solid #16a34a;
      }

      .task {
        padding: 12px;
        margin: 10px 0;
        background: #111;
        border-radius: 8px;
      }
    </style>
  </head>

  <body>
    <nav>
      <a href="index.html">Dashboard</a>
      <a href="track.html">Track</a>
      <a href="tasks.html">Tasks</a>
      <a href="notes.html">Notes</a>
      <a href="progress.html">Progress</a>
    </nav>

    <main>
      <h1>Tasks</h1>
      <section class="task-controls">
        <input id="taskTitle" placeholder="Task name" />

        <select id="urgency">
          <option value="high">üî• High urgency</option>
          <option value="medium">‚ö†Ô∏è Medium</option>
          <option value="low">üü¢ Low</option>
        </select>

        <textarea id="taskNotes" placeholder="Notes (optional)"></textarea>

        <button onclick="startTask()">Start Task</button>
      </section>

      <ul id="taskList"></ul>

      <!-- ADD TASK -->
      <div class="card">
        <h3>Add Task</h3>
        <input id="taskTitle" placeholder="Task title" />
        <select id="taskUrgency">
          <option value="critical">üî¥ Critical</option>
          <option value="high">üü† High</option>
          <option value="medium">üü° Medium</option>
          <option value="low">üü¢ Low</option>
        </select>
        <button onclick="addTask()">Add Task</button>
      </div>

      <!-- TASK LIST -->
      <div id="taskList"></div>
    </main>

    <!-- FIREBASE + AUTH + TASK LOGIC -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getFirestore,
        collection,
        addDoc,
        onSnapshot,
        query,
        orderBy,
        serverTimestamp,
        doc,
        deleteDoc,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
      import {
        getAuth,
        signInAnonymously,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDoFnzTnVlvebTeHly2tzkaV9tz-OxNvnw",
        authDomain: "tothemoon100percent.firebaseapp.com",
        projectId: "tothemoon100percent",
        storageBucket: "tothemoon100percent.firebasestorage.app",
        messagingSenderId: "1084909945870",
        appId: "1:1084909945870:web:4c29fb6da7d251daf4e85f",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      signInAnonymously(auth);

      let uid = null;
      auth.onAuthStateChanged((user) => {
        if (user) {
          uid = user.uid;
          loadTasks();
        }
      });

      window.addTask = async function addTask() {
        const title = document.getElementById("taskTitle").value;
        const urgency = document.getElementById("taskUrgency").value;
        if (!title) return;

        await addDoc(collection(db, "users", uid, "tasks"), {
          title,
          urgency,
          created: serverTimestamp(),
        });

        document.getElementById("taskTitle").value = "";
      };

      function loadTasks() {
        const q = query(
          collection(db, "users", uid, "tasks"),
          orderBy("urgency"),
          orderBy("created", "desc")
        );

        onSnapshot(q, (snap) => {
          const list = document.getElementById("taskList");
          list.innerHTML = "";

          snap.forEach((docSnap) => {
            const task = docSnap.data();
            const el = document.createElement("div");
            el.className = `card task urgent-${task.urgency}`;
            el.innerHTML = `
          <div class="task-title">${task.title}</div>
          <div class="small">Urgency: ${task.urgency}</div>
          <button onclick="deleteTask('${docSnap.id}')">Delete</button>
        `;
            list.appendChild(el);
          });
        });
      }

      window.deleteTask = async function (id) {
        await deleteDoc(doc(db, "users", uid, "tasks", id));
      };
      let activeTask = null;

      function startTask() {
        const title = document.getElementById("taskTitle").value;
        const urgency = document.getElementById("urgency").value;
        const notes = document.getElementById("taskNotes").value;

        if (!title) return alert("Task name required");

        activeTask = {
          title,
          urgency,
          notes,
          startTime: Date.now(),
        };

        document.getElementById("taskTitle").value = "";
        document.getElementById("taskNotes").value = "";
      }

      function stopTask() {
        if (!activeTask) return;

        const endTime = Date.now();

        const task = {
          ...activeTask,
          endTime,
          durationMs: endTime - activeTask.startTime,
          createdAt: new Date(),
        };

        saveTask(task);
        activeTask = null;
      }

      async function saveTask(task) {
        try {
          await addDoc(collection(db, "tasks"), task);
        } catch (e) {
          const local = JSON.parse(localStorage.getItem("tasks") || "[]");
          local.push(task);
          localStorage.setItem("tasks", JSON.stringify(local));
        }

        renderTasks();
      }
    </script>

    <script>
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("sw.js");
      }
    </script>
  </body>
</html>
